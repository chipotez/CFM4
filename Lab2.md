# Agregando RHEV como proveedor de Infraestructura

    [root@rhevm-6a77 ~]# vi /var/lib/pgsql/data/pg_hba.conf

Antes : 
    #IPv4 local connections:
    host      all       all     127.0.0.1/32    ident

Despues:

    # IPv4 local connections:
    host      all       all      0.0.0.0/0        md5

---------

cambiar ident por trust

    # IPv6 local connections:
    host        all       all       ::1/128       trust

---------

    [root@rhevm-6a77 ~]# vi /var/lib/pgsql/data/postgresql.conf

Descomentar :

    listen_addresses = '*'

--------

    [root@rhevm-6a77 ~]# service postgresql restart
    Stopping postgresql service:                               [  OK  ]
    Starting postgresql service:                               [  OK  ]

    [root@rhevm-6a77 ~]# psql -U postgres -h localhost
    psql (8.4.20)
    Type "help" for help.

    postgres=# create role cloudforms_history LOGIN unencrypted password 'redhat' superuser valid until 'infinity';
    CREATE ROLE
    postgres=# \q

### Agregando el dominio de IDM Server

    Lo primero es validar que nuestro DNS esta configurado en nuestro resolv.

    [root@rhevm1 /]# cat /etc/resolv.conf 
    ; generated by /sbin/dhclient-script
    nameserver 192.168.122.10
    nameserver 192.168.122.1

--------

    validamos nuestros servicios de LDAP (est√© proceso puede omitirse, en lo personal me gusta validarlo)

    [root@rhevm1 /]# dig _kerberos.poc.redhat.com TXT

        ; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.47.rc1.el6 <<>> _kerberos.poc.redhat.com TXT
        ;; global options: +cmd
        ;; Got answer:
        ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 60200
        ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1
        
        ;; QUESTION SECTION:
        ;_kerberos.poc.redhat.com.	IN	TXT
        
        ;; ANSWER SECTION:
        _kerberos.poc.redhat.com. 86400	IN	TXT	"POC.REDHAT.COM"
        
        ;; AUTHORITY SECTION:
        poc.redhat.com.		86400	IN	NS	idm.poc.redhat.com.
        
        ;; ADDITIONAL SECTION:
        idm.poc.redhat.com.	1200	IN	A	192.168.122.10
        
        ;; Query time: 0 msec
        ;; SERVER: 192.168.122.10#53(192.168.122.10)
        ;; WHEN: Sun Jun 12 13:15:08 2016
        ;; MSG SIZE  rcvd: 103

--------

        [root@rhevm1 /]# dig _kerberos-master._tcp.poc.redhat.com SRV
        
        ; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.47.rc1.el6 <<>> _kerberos-master._tcp.poc.redhat.com SRV
        ;; global options: +cmd
        ;; Got answer:
        ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 59555
        ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1
        
        ;; QUESTION SECTION:
        ;_kerberos-master._tcp.poc.redhat.com. IN SRV
        
        ;; ANSWER SECTION:
        _kerberos-master._tcp.poc.redhat.com. 86400 IN SRV 0 100 88 idm.poc.redhat.com.
        
        ;; AUTHORITY SECTION:
        poc.redhat.com.		86400	IN	NS	idm.poc.redhat.com.
        
        ;; ADDITIONAL SECTION:
        idm.poc.redhat.com.	1200	IN	A	192.168.122.10
        
        ;; Query time: 0 msec
        ;; SERVER: 192.168.122.10#53(192.168.122.10)
        ;; WHEN: Sun Jun 12 13:17:25 2016
        ;; MSG SIZE  rcvd: 122

--------

        [root@rhevm1 /]# dig _kerberos-master._udp.poc.redhat.com SRV
        
        ; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.47.rc1.el6 <<>> _kerberos-master._udp.poc.redhat.com SRV
        ;; global options: +cmd
        ;; Got answer:
        ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 52641
        ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1
        
        ;; QUESTION SECTION:
        ;_kerberos-master._udp.poc.redhat.com. IN SRV
        
        ;; ANSWER SECTION:
        _kerberos-master._udp.poc.redhat.com. 86400 IN SRV 0 100 88 idm.poc.redhat.com.
        
        ;; AUTHORITY SECTION:
        poc.redhat.com.		86400	IN	NS	idm.poc.redhat.com.
        
        ;; ADDITIONAL SECTION:
        idm.poc.redhat.com.	1200	IN	A	192.168.122.10
        
        ;; Query time: 0 msec
        ;; SERVER: 192.168.122.10#53(192.168.122.10)
        ;; WHEN: Sun Jun 12 13:18:24 2016
        ;; MSG SIZE  rcvd: 122


--------

        [root@rhevm1 /]# dig _kerberos._tcp.poc.redhat.com SRV
        
        ; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.47.rc1.el6 <<>> _kerberos._tcp.poc.redhat.com SRV
        ;; global options: +cmd
        ;; Got answer:
        ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 24445
        ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1
        
        ;; QUESTION SECTION:
        ;_kerberos._tcp.poc.redhat.com.	IN	SRV
        
        ;; ANSWER SECTION:
        _kerberos._tcp.poc.redhat.com. 86400 IN	SRV	0 100 88 idm.poc.redhat.com.
        
        ;; AUTHORITY SECTION:
        poc.redhat.com.		86400	IN	NS	idm.poc.redhat.com.
        
        ;; ADDITIONAL SECTION:
        idm.poc.redhat.com.	1200	IN	A	192.168.122.10
        
        ;; Query time: 0 msec
        ;; SERVER: 192.168.122.10#53(192.168.122.10)
        ;; WHEN: Sun Jun 12 13:19:22 2016
        ;; MSG SIZE  rcvd: 115

--------

        [root@rhevm1 /]# dig _kerberos._udp.poc.redhat.com SRV
        
        ; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.47.rc1.el6 <<>> _kerberos._udp.poc.redhat.com SRV
        ;; global options: +cmd
        ;; Got answer:
        ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 55186
        ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1
        
        ;; QUESTION SECTION:
        ;_kerberos._udp.poc.redhat.com.	IN	SRV
        
        ;; ANSWER SECTION:
        _kerberos._udp.poc.redhat.com. 86400 IN	SRV	0 100 88 idm.poc.redhat.com.
        
        ;; AUTHORITY SECTION:
        poc.redhat.com.		86400	IN	NS	idm.poc.redhat.com.
        
        ;; ADDITIONAL SECTION:
        idm.poc.redhat.com.	1200	IN	A	192.168.122.10
        
        ;; Query time: 0 msec
        ;; SERVER: 192.168.122.10#53(192.168.122.10)
        ;; WHEN: Sun Jun 12 13:19:28 2016
        ;; MSG SIZE  rcvd: 115

--------

        [root@rhevm1 /]# dig _kpasswd._tcp.poc.redhat.com SRV
        
        ; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.47.rc1.el6 <<>> _kpasswd._tcp.poc.redhat.com SRV
        ;; global options: +cmd
        ;; Got answer:
        ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 55586
        ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1
        
        ;; QUESTION SECTION:
        ;_kpasswd._tcp.poc.redhat.com.	IN	SRV
        
        ;; ANSWER SECTION:
        _kpasswd._tcp.poc.redhat.com. 86400 IN	SRV	0 100 464 idm.poc.redhat.com.
        
        ;; AUTHORITY SECTION:
        poc.redhat.com.		86400	IN	NS	idm.poc.redhat.com.
        
        ;; ADDITIONAL SECTION:
        idm.poc.redhat.com.	1200	IN	A	192.168.122.10
        
        ;; Query time: 0 msec
        ;; SERVER: 192.168.122.10#53(192.168.122.10)
        ;; WHEN: Sun Jun 12 13:20:45 2016
        ;; MSG SIZE  rcvd: 114

--------

        [root@rhevm1 /]# dig _kpasswd._udp.poc.redhat.com SRV
        
        ; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.47.rc1.el6 <<>> _kpasswd._udp.poc.redhat.com SRV
        ;; global options: +cmd
        ;; Got answer:
        ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61834
        ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1
        
        ;; QUESTION SECTION:
        ;_kpasswd._udp.poc.redhat.com.	IN	SRV
        
        ;; ANSWER SECTION:
        _kpasswd._udp.poc.redhat.com. 86400 IN	SRV	0 100 464 idm.poc.redhat.com.
        
        ;; AUTHORITY SECTION:
        poc.redhat.com.		86400	IN	NS	idm.poc.redhat.com.
        
        ;; ADDITIONAL SECTION:
        idm.poc.redhat.com.	1200	IN	A	192.168.122.10
        
        ;; Query time: 0 msec
        ;; SERVER: 192.168.122.10#53(192.168.122.10)
        ;; WHEN: Sun Jun 12 13:20:50 2016
        ;; MSG SIZE  rcvd: 114

--------

        [root@rhevm1 /]# dig _ldap._tcp.poc.redhat.com SRV
        
        ; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.47.rc1.el6 <<>> _ldap._tcp.poc.redhat.com SRV
        ;; global options: +cmd
        ;; Got answer:
        ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 26027
        ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1
        
        ;; QUESTION SECTION:
        ;_ldap._tcp.poc.redhat.com.	IN	SRV
        
        ;; ANSWER SECTION:
        _ldap._tcp.poc.redhat.com. 86400 IN	SRV	0 100 389 idm.poc.redhat.com.
        
        ;; AUTHORITY SECTION:
        poc.redhat.com.		86400	IN	NS	idm.poc.redhat.com.
        
        ;; ADDITIONAL SECTION:
        idm.poc.redhat.com.	1200	IN	A	192.168.122.10
        
        ;; Query time: 0 msec
        ;; SERVER: 192.168.122.10#53(192.168.122.10)
        ;; WHEN: Sun Jun 12 13:21:51 2016
        ;; MSG SIZE  rcvd: 111

--------

        [root@rhevm1 /]# dig _ntp._udp.poc.redhat.com SRV
        
        ; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.47.rc1.el6 <<>> _ntp._udp.poc.redhat.com SRV
        ;; global options: +cmd
        ;; Got answer:
        ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 16564
        ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1
        
        ;; QUESTION SECTION:
        ;_ntp._udp.poc.redhat.com.	IN	SRV
        
        ;; ANSWER SECTION:
        _ntp._udp.poc.redhat.com. 86400	IN	SRV	0 100 123 idm.poc.redhat.com.
        
        ;; AUTHORITY SECTION:
        poc.redhat.com.		86400	IN	NS	idm.poc.redhat.com.
        
        ;; ADDITIONAL SECTION:
        idm.poc.redhat.com.	1200	IN	A	192.168.122.10
        
        ;; Query time: 0 msec
        ;; SERVER: 192.168.122.10#53(192.168.122.10)
        ;; WHEN: Sun Jun 12 13:22:07 2016
        ;; MSG SIZE  rcvd: 110

Despoues de obtener las siguientes salidas podemos estar seguros que nuestros servicios estan correctamente funcionando y listos para aceptar las peticiones que necesitara RHEV-M.

###  Agregamos nuestro Dominio

        [root@rhevm1 /]# engine-manage-domains add --domain='poc.redhat.com' --provider=ipa --user=admin 
        Enter password:

        Failure while testing domain poc.redhat.com. Details: An internal error has ocurred in the Kerberos implementation of the Java virtual machine. This usually means that the LDAP server is configured with a minimum security strength factor (minssf) of 0. Change it to 1 and try again. You can also try to change the SASL quality of protection to "auth" which will lower the protection level.  To change the SASL quality of protection to "auth" use engine-config -s SASL_QOP=auth and restart engine.

------

        [root@rhevm1 /]# engine-config -s SASL_QOP=auth

        [root@rhevm1 /]# /etc/init.d/ovirt-engine restart
        Deteniendo oVirt Engine:                                   [  OK  ]
        Iniciando oVirt Engine:                                    [  OK  ]

------

        [root@rhevm1 /]# engine-manage-domains add --domain='poc.redhat.com' --provider=ipa --user=admin 
        Enter password:

        The domain poc.redhat.com has been added to the engine as an authentication source but no users from that domain have been granted permissions within the oVirt Manager.

        Users from this domain can be granted permissions from the Web administration interface logging in as admin@internal user.
        oVirt Engine restart is required in order for the changes to take place (service ovirt-engine restart).
        Manage Domains completed successfully

        [root@rhevm1 /]# service ovirt-engine restart
        Stopping oVirt Engine:                                     [  OK  ]
        Starting oVirt Engine:                                     [  OK  ]

------

        [root@rhevm1 /]# engine-manage-domains list

        Domain: poc.redhat.com
        	User name: admin@POC.REDHAT.COM
        Manage Domains completed successfully

------

        [root@rhevm1 /]# engine-manage-domains validate

        Domain poc.redhat.com is valid.
        The configured user for domain poc.redhat.com is admin@POC.REDHAT.COM

        Manage Domains completed successfully


------
